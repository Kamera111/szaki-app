<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard – Szaki-App</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    body { margin:0; padding:0; font-family:Arial; background:#f4f4f4; }

    header {
        background:#222; color:white; padding:14px;
        font-size:22px; text-align:center; font-weight:bold;
    }

    nav {
        background:#333; padding:10px; display:flex; gap:10px;
        justify-content:center; flex-wrap:wrap;
    }
    nav button {
        padding:10px 14px; border:none; border-radius:8px;
        background:#ff8c00; color:white; cursor:pointer; font-weight:bold;
    }

    .section {
        max-width:1200px; margin:20px auto; background:white;
        padding:20px; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,0.1);
    }

    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { padding:10px; border-bottom:1px solid #ddd; text-align:left; }
    th { background:#222; color:white; }

    .status { padding:4px 8px; border-radius:6px; color:white; }
    .online { background:#28a745; }
    .offline { background:#c00; }

    .order-status { font-weight:bold; }
    .active { color:#28a745; }
    .selected { color:#007bff; }
    .rejected { color:#c00; }

    .log-item {
        background:#fff7e1; border-left:4px solid #ff8c00;
        padding:10px; border-radius:6px; margin:6px 0;
        font-size:14px;
    }
</style>
</head>

<body>

<header>Admin Dashboard – Szaki-App</header>

<nav>
    <button onclick="showSection('chats')">Chat Monitor</button>
    <button onclick="showSection('statuses')">Szakik Online Státusz</button>
    <button onclick="showSection('orders')">Megrendelések</button>
    <button onclick="showSection('logs')">Tiltott Tartalom Log</button>
</nav>

<!-- ===================================================== -->
<!-- 1) CHAT MONITOR PANEL -->
<!-- ===================================================== -->
<div id="section-chats" class="section" style="display:block;">
    <h2>Chat Monitor</h2>
    <p><i>Valós időben frissül</i></p>

    <table>
        <thead>
            <tr>
                <th>Szoba ID</th>
                <th>Megrendelés ID</th>
                <th>Felhasználók</th>
                <th>Státusz</th>
                <th>Utolsó üzenet</th>
                <th>Megnyitás</th>
            </tr>
        </thead>
        <tbody id="chat-list"></tbody>
    </table>
</div>

<!-- ===================================================== -->
<!-- 2) ONLINE STATUS PANEL -->
<!-- ===================================================== -->
<div id="section-statuses" class="section" style="display:none;">
    <h2>Szakik online / offline</h2>

    <table>
        <thead>
            <tr>
                <th>Név</th>
                <th>Szakma</th>
                <th>Státusz</th>
                <th>Utoljára aktív</th>
            </tr>
        </thead>
        <tbody id="status-list"></tbody>
    </table>
</div>

<!-- ===================================================== -->
<!-- 3) MEGRENDELÉSEK PANEL -->
<!-- ===================================================== -->
<div id="section-orders" class="section" style="display:none;">
    <h2>Összes megrendelés</h2>

    <table>
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Megrendelő</th>
                <th>Szakma</th>
                <th>Leírás</th>
                <th>Státusz</th>
                <th>Időpont</th>
            </tr>
        </thead>
        <tbody id="orders-list"></tbody>
    </table>
</div>

<!-- ===================================================== -->
<!-- 4) TILTOTT TARTALOM LOG -->
<!-- ===================================================== -->
<div id="section-logs" class="section" style="display:none;">
    <h2>Tiltott tartalom log</h2>
    <p><i>Telefonszám / Email / Link próbálkozások listázása</i></p>

    <div id="logs-container"></div>
</div>

<script type="module">

import { app, db } from "./firebase-config.js";
import {
    collection, query, orderBy, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

function showSection(name){
    document.querySelectorAll(".section").forEach(sec => sec.style.display="none");
    document.getElementById("section-" + name).style.display="block";
}

/* ============================================================
   1) CHAT MONITOR
============================================================ */
const chatListEl = document.getElementById("chat-list");
const chatsRef = collection(db, "chats");
onSnapshot(query(chatsRef, orderBy("lastMessageAt","desc")), (snap)=>{
    chatListEl.innerHTML="";
    snap.forEach(doc=>{
        const d = doc.data();
        const users = d.users?.join(", ") || "-";
        const status = d.status || "active";

        const last = d.lastMessageAt?.toDate().toLocaleString("hu-HU") || "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${d.roomId}</td>
            <td>${d.orderId || "-"}</td>
            <td>${users}</td>
            <td class="order-status ${status}">${status}</td>
            <td>${last}</td>
            <td><button onclick="window.open('chat.html?orderId=${d.orderId}&sender=${users.split(', ')[0]}&partner=${users.split(', ')[1]}','_blank')">Megnyitás</button></td>
        `;
        chatListEl.appendChild(tr);
    });
});

/* ============================================================
   2) SZAKIK ONLINE STATUS
============================================================ */
const statusListEl = document.getElementById("status-list");
const statusRef = collection(db, "userStatus");

onSnapshot(statusRef, (snap)=>{
    statusListEl.innerHTML="";
    snap.forEach(doc=>{
        const d = doc.data();
        const last = d.lastActive?.toDate().toLocaleString("hu-HU") || "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${d.name}</td>
            <td>${d.profession || "-"}</td>
            <td><span class="status ${d.online ? "online" : "offline"}">${d.online ? "Online" : "Offline"}</span></td>
            <td>${last}</td>
        `;
        statusListEl.appendChild(tr);
    });
});

/* ============================================================
   3) MEGRENDELÉSEK LISTÁJA
============================================================ */
const ordersListEl = document.getElementById("orders-list");
const ordersRef = collection(db, "orders");

onSnapshot(query(ordersRef, orderBy("timestamp","desc")), (snap)=>{
    ordersListEl.innerHTML="";
    snap.forEach(doc=>{
        const d = doc.data();
        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${d.orderId}</td>
            <td>${d.name}</td>
            <td>${d.szakma}</td>
            <td>${(d.leiras || "").substring(0,40)}...</td>
            <td class="order-status ${d.status}">${d.status}</td>
            <td>${d.timestamp?.toDate().toLocaleString("hu-HU")}</td>
        `;

        ordersListEl.appendChild(tr);
    });
});

/* ============================================================
   4) TILTOTT TARTALOM LOG
============================================================ */
const logsContainer = document.getElementById("logs-container");
const logsRef = collection(db, "blockedMessages");

onSnapshot(query(logsRef, orderBy("timestamp","desc")), (snap)=>{
    logsContainer.innerHTML="";
    snap.forEach(doc=>{
        const d = doc.data();
        const div = document.createElement("div");
        div.className = "log-item";

        div.innerHTML = `
            <b>${d.sender}</b> próbált tiltott adatot küldeni:<br>
            <b>Szöveg:</b> ${d.text}<br>
            <b>Chat:</b> ${d.roomId} | <b>Idő:</b> ${d.timestamp?.toDate().toLocaleString("hu-HU")}
        `;

        logsContainer.appendChild(div);
    });
});

</script>

</body>
</html>
