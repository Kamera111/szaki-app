<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Chat lista ‚Äì SzakiChat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">

    <style>
        .chat-item {
            background:white;
            padding:16px;
            border-radius:12px;
            box-shadow:0 2px 10px rgba(0,0,0,0.08);
            margin-bottom:14px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            cursor:pointer;
        }

        .chat-title {
            font-size:17px;
            font-weight:bold;
        }

        .online {
            color:#22bb33;
            font-size:13px;
        }
        .offline {
            color:#777;
            font-size:13px;
        }
    </style>
</head>

<body>

<header>Chat besz√©lget√©sek</header>

<div class="container">
    <div id="chatList">Bet√∂lt√©s...</div>
</div>

<!-- ‚ù§Ô∏è Lebeg≈ë t√°mogat√°s gomb -->
<div id="supportFloatingBtn"
     onclick="window.open('https://www.paypal.com/donate/?hosted_button_id=QGU3WXVSCH22A','_blank')">
    <span class="heart">‚ù§Ô∏è</span> T√°mogasd a SzakiChat-et
</div>

<script type="module">
/* ============================================================
   FIREBASE IMPORT
============================================================ */
import { auth, db } from "./firebase-config.js";

import {
    onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
    collection,
    query,
    where,
    getDocs,
    doc,
    getDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let uid = null;
let userData = null;

/* ============================================================
   BEL√âP√âS ELLEN≈êRZ√âS
============================================================ */
onAuthStateChanged(auth, async (user) => {
    if (!user) return (window.location.href = "login.html");

    uid = user.uid;

    const meRef = doc(db, "users", uid);
    const meSnap = await getDoc(meRef);
    userData = meSnap.data();

    loadChatList();
});


/* ============================================================
   CHAT LISTA BEOLVAS√ÅSA
============================================================ */
async function loadChatList() {
    const listBox = document.getElementById("chatList");
    listBox.innerHTML = "Bet√∂lt√©s...";

    const q = query(
        collection(db, "chats"),
        where("participants", "array-contains", uid)
    );

    const snap = await getDocs(q);

    if (snap.empty) {
        listBox.innerHTML = "<p>M√©g nincs besz√©lget√©s.</p>";
        return;
    }

    listBox.innerHTML = "";

    snap.forEach(async (chatDoc) => {
        const chat = chatDoc.data();
        const chatID = chatDoc.id;

        const partnerID = chat.participants.find(p => p !== uid);

        // Partner adatainak lek√©r√©se
        const partnerRef = doc(db, "users", partnerID);
        const partnerSnap = await getDoc(partnerRef);

        if (!partnerSnap.exists()) return;

        const partner = partnerSnap.data();

        const div = document.createElement("div");
        div.className = "chat-item";

        div.innerHTML = `
            <div>
                <div class="chat-title">${partner.name || partner.email}</div>
                <div class="${partner.online ? 'online' : 'offline'}">
                    ${partner.online ? "üü¢ Online" : "‚ö™ Offline"}
                </div>
            </div>

            <div style="font-size:22px;">‚û°</div>
        `;

        div.onclick = () => {
            window.location.href = `chat.html?chatID=${chatID}&partner=${partnerID}`;
        };

        listBox.appendChild(div);
    });
}
</script>

</body>
</html>
