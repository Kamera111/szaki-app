<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Chat – Szaki-App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body { margin:0; padding:0; background:#f5f5f5; font-family:Arial,sans-serif; }

    header {
      background:#ff8c00; padding:12px 16px; color:#fff;
      font-weight:bold; font-size:18px; text-align:center;
    }

    .top-bar {
      max-width:900px; margin:0 auto; background:white;
      padding:10px 14px; border-bottom:1px solid #eee; font-size:13px;
    }

    #chat-box{
      max-width:900px; margin:12px auto; padding:12px 14px;
      background:white; border-radius:10px;
      height:55vh; overflow-y:auto; box-shadow:0 2px 10px rgba(0,0,0,0.08);
    }

    .msg{ margin:6px 0; font-size:14px; }
    .own{ font-weight:bold; }
    .meta{ font-size:11px; color:#777; margin-left:6px; }

    .input-row{
      max-width:900px; margin:0 auto 14px; padding:0 14px;
      display:flex; gap:8px;
    }

    #message-input{
      flex:1; padding:10px; border-radius:8px;
      border:1px solid #ccc; font-size:14px;
    }

    .send-btn{
      padding:10px 18px; background:#ff8c00; border:none;
      border-radius:8px; color:white; font-weight:bold;
      cursor:pointer;
    }

    /* ---- POPUP ---- */
    #rating-popup {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.55);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:999;
    }

    #rating-box {
      background:white;
      width:90%;
      max-width:420px;
      padding:20px;
      border-radius:12px;
      text-align:center;
      box-shadow:0 4px 20px rgba(0,0,0,0.25);
    }

    .star {
      font-size:32px;
      cursor:pointer;
      color:#ddd;
    }
    .star.active {
      color:#ffb300;
    }

    textarea {
      width:100%;
      padding:10px;
      margin-top:12px;
      border-radius:8px;
      border:1px solid #aaa;
      resize:none;
      height:80px;
    }

    #submit-rating {
      margin-top:14px;
      width:100%;
      padding:12px;
      border:none;
      border-radius:8px;
      background:#ff8c00;
      color:white;
      font-size:15px;
      font-weight:bold;
      cursor:pointer;
    }
  </style>
</head>

<body>

<header>Chat – Szaki-App</header>

<div class="top-bar" id="top-bar"></div>

<div id="chat-box">
  <p><i>Csatlakoztál a beszélgetéshez…</i></p>
</div>

<!-- ------------------ ÉRTÉKELŐ POPUP ------------------- -->
<div id="rating-popup">
  <div id="rating-box">
    <h3>Értékeld a szakembert</h3>

    <div id="stars">
      <span class="star" data-v="1">★</span>
      <span class="star" data-v="2">★</span>
      <span class="star" data-v="3">★</span>
      <span class="star" data-v="4">★</span>
      <span class="star" data-v="5">★</span>
    </div>

    <textarea id="rating-text" placeholder="Rövid vélemény…"></textarea>

    <button id="submit-rating">Értékelés elküldése</button>
  </div>
</div>
<!-- ------------------------------------------------------ -->

<div class="input-row">
  <input type="text" id="message-input" placeholder="Írj üzenetet…" />
  <button class="send-btn" id="send-btn">Küldés</button>
</div>

<script type="module">

  import { app, db } from "./firebase-config.js";
  import {
      collection, doc, addDoc, query, orderBy, onSnapshot,
      serverTimestamp, updateDoc, setDoc, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  /* ============ PARAMÉTEREK =============== */
  const params = new URLSearchParams(window.location.search);

  let USER_NAME = params.get("sender") || localStorage.getItem("szakiName");
  const PARTNER_NAME = params.get("partner") || "Ismeretlen";
  const ORDER_ID = params.get("orderId") || null;

  if (!USER_NAME) {
      USER_NAME = prompt("Add meg a neved:") || "Ismeretlen";
      localStorage.setItem("szakiName", USER_NAME);
  }

  const ROOM_ID = [USER_NAME.toLowerCase(), PARTNER_NAME.toLowerCase()].sort().join("__");

  document.getElementById("top-bar").innerHTML =
    `<b>Te:</b> ${USER_NAME} &nbsp; | &nbsp;
     <b>Szakember:</b> ${PARTNER_NAME}
     ${ORDER_ID ? ` | <b>Megrendelés azonosító:</b> ${ORDER_ID}` : ""}`;

  /* ============ FIRESTORE REFERENCIÁK =============== */
  const chatRef = doc(db, "chats", ROOM_ID);
  const messagesRef = collection(db, "chats", ROOM_ID, "uzenetek");

  try {
      await updateDoc(chatRef, {
          roomId: ROOM_ID,
          members: {
              you: USER_NAME,
              partner: PARTNER_NAME,
              orderId: ORDER_ID
          },
          status: "active",
          lastMessageAt: serverTimestamp()
      });
  } catch (e) {}

  /* ============ CHAT FIGYELŐ =============== */
  const chatBox = document.getElementById("chat-box");
  const q = query(messagesRef, orderBy("timestamp"));

  onSnapshot(q, (snap) => {
      chatBox.innerHTML = "";
      snap.forEach(m => {
          const d = m.data();

          const p = document.createElement("p");
          p.className = "msg";

          const own = d.senderName === USER_NAME ? "own" : "";
          const time = d.timestamp?.toDate().toLocaleTimeString("hu-HU",{hour:"2-digit",minute:"2-digit"});

          p.innerHTML =
            `<span class="${own}">${d.senderName}:</span> ` +
            `${escapeHtml(d.text)} <span class="meta">(${time})</span>`;

          chatBox.appendChild(p);
      });

      chatBox.scrollTop = chatBox.scrollHeight;
  });

  /* ============ ÜZENET KÜLDÉS =============== */
  document.getElementById("send-btn").onclick = sendMsg;
  document.getElementById("message-input").onkeydown = e => {
      if (e.key === "Enter") sendMsg();
  };

  async function sendMsg() {
      const input = document.getElementById("message-input");
      const text = input.value.trim();
      if (!text) return;

      await addDoc(messagesRef, {
          senderName: USER_NAME,
          text,
          timestamp: serverTimestamp()
      });

      await updateDoc(chatRef, {
          lastMessageAt: serverTimestamp()
      });

      input.value = "";
  }

  /* =====================================================
       MEGRENDELŐ ÉRTÉKELŐ POPUP
  ====================================================== */

  const popup = document.getElementById("rating-popup");
  const stars = [...document.querySelectorAll(".star")];
  let selectedStars = 0;

  stars.forEach(s => {
      s.onclick = () => {
          selectedStars = Number(s.dataset.v);
          stars.forEach(st => st.classList.remove("active"));
          for (let i=0; i<selectedStars; i++) stars[i].classList.add("active");
      };
  });

  function openRatingPopup(){
      popup.style.display = "flex";
  }

  /* ----- ÉRTÉKELÉS KÜLDÉSE ----- */
  document.getElementById("submit-rating").onclick = async () => {

      const text = document.getElementById("rating-text").value.trim();

      if (selectedStars < 1) {
          alert("Adj csillagot!");
          return;
      }

      // --- ratings gyűjtemény ---
      await addDoc(collection(db, "ratings"), {
          szakiName: PARTNER_NAME,
          fromUser: USER_NAME,
          stars: selectedStars,
          text,
          createdAt: serverTimestamp()
      });

      // --- ratingSummary frissítése ---
      await updateRatingSummary(PARTNER_NAME);

      alert("Köszönjük az értékelést!");
      popup.style.display = "none";
  };

  async function updateRatingSummary(szakiName){
      const snap = await getDocs(collection(db, "ratings"));
      let sum = 0, count = 0;

      snap.forEach(d => {
          const r = d.data();
          if (r.szakiName === szakiName){
              sum += r.stars;
              count++;
          }
      });

      await setDoc(doc(db, "szakik", szakiName, "ratingSummary", "stats"), {
          avg: count ? (sum / count) : 0,
          count
      });
  }

  /* =====================================================
       CHAT BEZÁRÁSAKOR MUTASSUK AZ ÉRTÉKELŐ POPUPOT
  ====================================================== */

  window.addEventListener("beforeunload", () => {
      if (USER_NAME !== PARTNER_NAME) {
          openRatingPopup();
      }
  });

  /* =====================================================
       SEGÉDEK
  ====================================================== */
  function escapeHtml(s){
      const div = document.createElement("div");
      div.innerText = s;
      return div.innerHTML;
  }

</script>

</body>
</html>
