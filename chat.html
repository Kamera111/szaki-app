<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Chat ‚Äì SzakiChat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">

    <style>
        body {
            display:flex;
            flex-direction:column;
            height:100vh;
            overflow:hidden;
            background:#f0f0f0;
        }

        #chatHeader {
            background:#007aff;
            color:white;
            padding:14px;
            font-size:18px;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        #messages {
            flex:1;
            overflow-y:auto;
            padding:16px;
        }

        .msg {
            max-width:75%;
            padding:10px 14px;
            border-radius:12px;
            margin-bottom:12px;
            word-wrap:break-word;
            font-size:15px;
            box-shadow:0 2px 6px rgba(0,0,0,0.08);
        }

        .me {
            background:#007aff;
            color:white;
            margin-left:auto;
        }

        .other {
            background:white;
            color:black;
            margin-right:auto;
        }

        #inputBar {
            display:flex;
            padding:10px;
            background:white;
            border-top:1px solid #ddd;
        }

        #msgInput {
            flex:1;
            padding:10px;
            border:1px solid #ccc;
            border-radius:8px;
            margin-right:10px;
        }

        #sendBtn {
            background:#007aff;
            color:white;
            padding:10px 16px;
            border:none;
            border-radius:8px;
            cursor:pointer;
        }

        #lockWarning {
            text-align:center;
            padding:10px;
            background:#ffe3dd;
            color:#a10000;
            font-size:14px;
            font-weight:bold;
            display:none;
        }
    </style>
</head>

<body>

<div id="chatHeader">
    <div id="partnerName">Chat</div>
    <div id="partnerStatus">‚ö™</div>
</div>

<div id="lockWarning">üîí El√©rhet≈ës√©g k√ºld√©se z√°rolva! Legal√°bb 5 megoszt√°s kell.</div>

<div id="messages">Bet√∂lt√©s...</div>

<div id="inputBar">
    <input id="msgInput" type="text" placeholder="√çrj √ºzenetet...">
    <button id="sendBtn">K√ºld√©s</button>
</div>


<!-- ‚ù§Ô∏è Lebeg≈ë t√°mogat√°s gomb -->
<div id="supportFloatingBtn"
     onclick="window.open('https://www.paypal.com/donate/?hosted_button_id=QGU3WXVSCH22A','_blank')">
    <span class="heart">‚ù§Ô∏è</span> T√°mogasd a SzakiChat-et
</div>


<script type="module">
/* ============================================================
   FIREBASE IMPORT
============================================================ */
import { auth, db } from "./firebase-config.js";

import {
    onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
    doc,
    getDoc,
    setDoc,
    updateDoc,
    collection,
    addDoc,
    query,
    orderBy,
    onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";


/* ============================================================
   URL PARAM√âTEREK
============================================================ */
const params = new URLSearchParams(window.location.search);
const chatID = params.get("chatID");
const partnerID = params.get("partner");

let uid = null;
let userData = null;
let partnerData = null;


/* ============================================================
   BEL√âP√âS ELLEN≈êRZ√âS
============================================================ */
onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "login.html";

    uid = user.uid;

    // SAJ√ÅT ADATOK
    const meRef = doc(db, "users", uid);
    const meSnap = await getDoc(meRef);
    userData = meSnap.data();

    // PARTNER ADATOK
    const pRef = doc(db, "users", partnerID);
    const pSnap = await getDoc(pRef);
    partnerData = pSnap.data();

    document.getElementById("partnerName").innerText =
        partnerData.name || partnerData.email;

    document.getElementById("partnerStatus").innerText =
        partnerData.online ? "üü¢" : "‚ö™";

    loadMessages();
});


/* ============================================================
   √úZENETEK BET√ñLT√âSE REALTIME
============================================================ */
function loadMessages() {
    const msgBox = document.getElementById("messages");
    msgBox.innerHTML = "Bet√∂lt√©s...";

    const q = query(
        collection(db, "chats", chatID, "messages"),
        orderBy("timestamp", "asc")
    );

    onSnapshot(q, (snap) => {
        msgBox.innerHTML = "";

        snap.forEach((docu) => {
            const msg = docu.data();

            const div = document.createElement("div");
            div.className = "msg " + (msg.sender === uid ? "me" : "other");
            div.innerText = msg.text;

            msgBox.appendChild(div);
        });

        // Auto-scroll
        msgBox.scrollTop = msgBox.scrollHeight;
    });
}


/* ============================================================
   K√úLD√âS GOMB
============================================================ */
document.getElementById("sendBtn").onclick = sendMessage;
document.getElementById("msgInput").addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendMessage();
});


/* ============================================================
   √úZENET K√úLD√âSE
============================================================ */
async function sendMessage() {
    const input = document.getElementById("msgInput");
    const text = input.value.trim();
    if (!text) return;

    // El√©rhet≈ës√©g z√°rolva
    if (userData.shareCount < 5 && looksLikePhone(text)) {
        document.getElementById("lockWarning").style.display = "block";
        return;
    }

    await addDoc(collection(db, "chats", chatID, "messages"), {
        text,
        sender: uid,
        timestamp: Date.now()
    });

    // Chat metadata friss√≠t√©s
    await updateDoc(doc(db, "chats", chatID), {
        lastMessage: text,
        lastTimestamp: Date.now()
    });

    input.value = "";
}


/* ============================================================
   TELEFONSZ√ÅM / EMAIL MINTA V√âDELEM
============================================================ */
function looksLikePhone(text) {
    return /[0-9]{6,}/.test(text); // egyszer≈± telefonsz√°m mint√°zat
}

/* TODO: k√©s≈ëbb email tilt√°s is hozz√°adhat√≥ */
</script>

</body>
</html>
