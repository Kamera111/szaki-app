<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <title>Chat – Szaki-App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#f5f5f5; }
    header { background:#ff8c00; color:#fff; padding:14px; text-align:center; font-weight:bold; }
    .container { max-width:900px; margin:16px auto; padding:12px; }
    .meta { background:#fff; padding:10px 12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
    .meta div { margin:4px 0; }
    .you-are { font-size:13px; color:#007700; margin-top:6px; }
    .chat-window { background:#fff; height:60vh; overflow:auto; border-radius:8px; margin-top:12px; padding:12px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
    .msg { margin:8px 0; max-width:75%; padding:8px 10px; border-radius:10px; }
    .msg.me { background:#dcf8c6; margin-left:auto; text-align:right; }
    .msg.other { background:#f1f0f0; margin-right:auto; text-align:left; }
    .composer { display:flex; gap:8px; margin-top:10px; }
    input[type="text"] { flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:14px; }
    button { padding:10px 14px; border-radius:8px; border:none; background:#28a745; color:#fff; font-weight:bold; cursor:pointer; }
    a.back { display:inline-block; margin-top:8px; color:#007bff; text-decoration:none; }
    .note { font-size:13px; color:#666; margin-top:8px; }
    .timestamp { font-size:11px; color:#888; margin-top:6px; }
    .who { font-size:12px; color:#555; }
  </style>
</head>
<body>
<header>Chat – Szaki-App</header>
<div class="container">
  <div class="meta" id="meta">
    <div><strong>Megrendelő:</strong> <span id="megrendelonevText">-</span></div>
    <div><strong>Szakember:</strong> <span id="partnerText">-</span></div>
    <div id="youAre" class="you-are" aria-live="polite"></div>
    <a id="backLink" class="back" href="#">◀ Vissza a kereséshez</a>
  </div>

  <div id="chatWindow" class="chat-window" aria-live="polite" aria-label="Beszélgetés"></div>

  <div class="composer">
    <input id="msgInput" type="text" placeholder="Írj üzenetet..." aria-label="Üzenet beviteli mező" />
    <button id="sendBtn" type="button">Küldés</button>
  </div>

  <div class="note">
    Valós idejű chat Cloud Firestore használatával. Teszteléshez állítsd ideiglenesen olvasási/írási szabályokat.
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  function getParam(name) {
    return new URLSearchParams(window.location.search).get(name) || "";
  }

  // URL paramok
  const senderParam = decodeURIComponent(getParam('sender') || '').trim() || '';
  const partnerParam = decodeURIComponent(getParam('partner') || '').trim() || '';
  const megrendelonevParam = decodeURIComponent(getParam('megrendelonev') || '').trim() || '';

  // Egyszerű normalizálás: ékezetek eltávolítása és kisbetű
  function removeDiacritics(s) {
    return s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  }
  function normalizeKey(s) {
    return removeDiacritics(String(s || '').trim().toLowerCase());
  }

  // Alias tábla: gyakori variánsok kanonizálása (bővíthető)
  const aliasMap = {
    'zsolt': 'zsolti',
    'zsolti': 'zsolti',
    'janos': 'janos',
    'jános': 'janos'
    // ide adhatsz további aliasokat, pl. 'csabi':'csabi'
  };

  function canonicalNameDisplay(orig) {
    // visszaadja a megjelenítendő (eredeti) forma: megtartjuk a bemenet nagybetűs formázását, ha van
    const s = String(orig || '').trim();
    if (!s) return s;
    // ha kisbetűs kanonikus név ismert, térj vissza a normált megjelenítéssel (pl. 'zsolti' -> 'Zsolti')
    const key = normalizeKey(s);
    const canon = aliasMap[key] || key;
    // visszaalakítjuk: első betű nagy
    return canon ? (canon.charAt(0).toUpperCase() + canon.slice(1)) : s;
  }

  function canonicalKey(orig) {
    const key = normalizeKey(orig || '');
    return aliasMap[key] || key || '';
  }

  // Döntés: melyik név a Megrendelő és melyik a Szakember a fejlécben
  // Ha megrendelonevParam megvan, azt használjuk Megrendelőnek, partnerParam lesz a Szakember.
  // Külön figyelem: ha partnerParam üres vagy megrendelonevParam==partnerParam, visszazuhanunk sender/partner logikára.
  let displayMegrendelonev, displayPartner;
  if (megrendelonevParam) {
    displayMegrendelonev = canonicalNameDisplay(megrendelonevParam);
    displayPartner = canonicalNameDisplay(partnerParam || senderParam || '');
  } else {
    displayMegrendelonev = canonicalNameDisplay(senderParam || '');
    displayPartner = canonicalNameDisplay(partnerParam || '');
  }

  // "Te most" (az aktív felhasználó) a senderParam
  const youAreDisplay = canonicalNameDisplay(senderParam || '');

  // Ha partner és megrendelő azonosak (pl. elgépelés), próbáljuk javítani: ha partnerKey equals senderKey, akkor partner=partnerParam, megrendelonev=megrendelonevParam
  // De jobb megoldás: a chat azonosító a kanonikus kulcsokból készül
  document.getElementById('megrendelonevText').textContent = displayMegrendelonev || '-';
  document.getElementById('partnerText').textContent = displayPartner || '-';
  document.getElementById('youAre').textContent = 'Te most: ' + (youAreDisplay || senderParam || 'Ismeretlen');

  (function setupBackLink(){
    const params = new URLSearchParams(window.location.search);
    let backUrl = 'valassz-szakit.html';
    const szakma = params.get('szakma');
    const megr = params.get('megrendelonev');
    const bp = new URLSearchParams();
    if (szakma) bp.set('szakma', szakma);
    if (megr) bp.set('megrendelonev', megr);
    const q = bp.toString();
    if (q) backUrl += '?' + q;
    document.getElementById('backLink').href = backUrl;
  })();

  // ====== IDE ILLESZD BE A SAJÁT FIREBASE KONFIGODAT -----
  const firebaseConfig = {
    apiKey: "AIzaSyAKhHvi3yObUurBKhT1r_feg4g0A5w766Q",
    authDomain: "szaki-app.firebaseapp.com",
    projectId: "szaki-app",
    storageBucket: "szaki-app.appspot.com",
    messagingSenderId: "418149364598",
    appId: "1:418149364598:web:2ae4450dc8fadfbac30057"
  };
  // ----------------------------------------------------

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Chat azonosító: mindig a kanonikus kulcsokból, rendezve készül (így mindkét irány ugyanoda ír)
  // Külön figyelünk arra, hogy ha megrendelonevParam megvan, azt használjuk az egyik résztvevőnek.
  const keyA = canonicalKey(megrendelonevParam || senderParam || '');
  const keyB = canonicalKey(partnerParam || '');
  const cidCandidates = [keyA, keyB].filter(Boolean);
  // ha véletlenül a partner üres, fallback sender/partner logika
  if (cidCandidates.length < 2) {
    cidCandidates.length = 0;
    cidCandidates.push(canonicalKey(senderParam || ''));
    if (partnerParam) cidCandidates.push(canonicalKey(partnerParam));
  }
  const cid = cidCandidates.sort().join('_') || (canonicalKey(senderParam) + '_' + canonicalKey(partnerParam));
  const messagesCol = collection(db, 'chats', cid, 'uzenetek');
  const q = query(messagesCol, orderBy('when', 'asc'));

  // Valós idejű figyelés
  onSnapshot(q, snapshot => {
    const wnd = document.getElementById('chatWindow');
    wnd.innerHTML = '';
    snapshot.forEach(doc => {
      const m = doc.data();
      appendMessageToWindow(m);
    });
  }, err => {
    console.error('Firestore onSnapshot error', err);
  });

  function appendMessageToWindow(m){
    const wnd = document.getElementById('chatWindow');
    const d = document.createElement('div');
    // "me" döntés: m.from kanonikus kulcsa egyezik-e a senderParam kanonikus kulcsával
    const fromKey = canonicalKey(m.from || '');
    const senderKey = canonicalKey(senderParam || '');
    d.className = 'msg ' + (fromKey && senderKey && fromKey === senderKey ? 'me' : 'other');

    const who = document.createElement('div');
    who.className = 'who';
    // megjelenítéshez kanonikus megjelenítőt használunk
    who.textContent = canonicalNameDisplay(m.from || '');

    const text = document.createElement('div');
    text.style.marginTop = '4px';
    text.textContent = m.text;

    const ts = document.createElement('div');
    ts.className = 'timestamp';
    try {
      if (m.when && m.when.toDate) ts.textContent = m.when.toDate().toLocaleString();
      else if (m.when) ts.textContent = new Date(m.when).toLocaleString();
      else ts.textContent = '';
    } catch (e) { ts.textContent = ''; }

    d.appendChild(who); d.appendChild(text); d.appendChild(ts);
    wnd.appendChild(d);
    wnd.scrollTop = wnd.scrollHeight;
  }

  async function sendMessage(text){
    if (!text || !text.trim()) return;
    try {
      await addDoc(messagesCol, {
        from: senderParam || '',
        text: text.trim(),
        when: serverTimestamp()
      });
    } catch (e) {
      console.error('sendMessage error', e);
      alert('Hiba: nem sikerült elküldeni az üzenetet.');
    }
  }

  document.getElementById('sendBtn').addEventListener('click', function(){
    const inp = document.getElementById('msgInput');
    sendMessage(inp.value);
    inp.value = '';
    inp.focus();
  });

  document.getElementById('msgInput').addEventListener('keydown', function(e){
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('sendBtn').click();
    }
  });

  if (!getParam('sender') || !getParam('partner')) {
    const note = document.createElement('div');
    note.className = 'note';
    note.textContent = 'Figyelem: a chat működéséhez a sender és partner paraméter megadása ajánlott az URL-ben.';
    document.querySelector('.container').insertBefore(note, document.querySelector('.container').lastElementChild);
  }
</script>
</body>
</html>
