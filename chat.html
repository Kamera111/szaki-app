<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Chat ‚Äì Szaki-App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body { margin:0; padding:0; background:#f5f5f5; font-family:Arial,sans-serif; }

    header {
      background:#ff8c00; padding:12px 16px; color:#fff;
      font-weight:bold; font-size:18px; text-align:center;
    }

    .top-bar{
      max-width:900px; margin:0 auto; background:white;
      padding:10px 14px; border-bottom:1px solid #eee; font-size:13px;
    }
    .top-row{ display:flex; flex-wrap:wrap; gap:16px; }

    #chat-box{
      max-width:900px; margin:12px auto; padding:12px 14px;
      background:white; border-radius:10px;
      height:55vh; overflow-y:auto; box-shadow:0 2px 10px rgba(0,0,0,0.08);
    }

    .msg{ margin:6px 0; font-size:14px; }
    .own{ font-weight:bold; }
    .meta{ font-size:11px; color:#777; margin-left:6px; }

    .warning-msg{
      margin:6px 0; padding:10px; background:#fff7e1;
      border-left:4px solid #ff8c00; border-radius:6px;
      font-size:13px; color:#8a5a00;
    }

    .input-row{
      max-width:900px; margin:0 auto 14px; padding:0 14px;
      display:flex; gap:8px;
    }

    #message-input{
      flex:1; padding:10px; border-radius:8px;
      border:1px solid #ccc; font-size:14px;
    }

    .send-btn{
      padding:10px 18px; background:#ff8c00; border:none;
      border-radius:8px; color:white; font-weight:bold;
      cursor:pointer;
    }

    /* v√°laszt√≥ gombok */
    #select-buttons{
      max-width:900px; margin:10px auto; padding:0 14px;
      display:flex; gap:10px;
    }
    #select-buttons button{
      flex:1; padding:10px; border:none; border-radius:8px;
      font-weight:bold; color:white; cursor:pointer;
    }
    #select-worker{ background:#28a745; }
    #select-other{ background:#c00; }
  </style>
</head>

<body>

<header>Chat ‚Äì Szaki-App</header>

<div class="top-bar" id="top-bar"></div>

<div id="chat-box">
  <p><i>Csatlakozt√°l a besz√©lget√©shez‚Ä¶</i></p>
</div>

<!-- Szakiv√°laszt√°s visszajelz√©s -->
<div id="select-buttons">
    <button id="select-worker">Ezt a szakit v√°lasztom</button>
    <button id="select-other">M√°sik szakit v√°lasztottam</button>
</div>

<div class="input-row">
  <input type="text" id="message-input" placeholder="√çrj √ºzenetet‚Ä¶" />
  <button class="send-btn" id="send-btn">K√ºld√©s</button>
</div>

<script type="module">

  import { app, db } from "./firebase-config.js";
  import {
      collection, doc, addDoc, query, orderBy, onSnapshot,
      serverTimestamp, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";


  // -------------------------------------------------------------
  // PARAM√âTEREK
  // -------------------------------------------------------------
  const params = new URLSearchParams(window.location.search);

  let USER_NAME = params.get("sender") || localStorage.getItem("szakiName");
  if (!USER_NAME) {
      USER_NAME = prompt("Add meg a neved:") || "Ismeretlen";
  }
  localStorage.setItem("szakiName", USER_NAME);

  const PARTNER_NAME = params.get("partner") || "Ismeretlen";
  const ROOM_ID = createRoomId(USER_NAME, PARTNER_NAME);

  const topBar = document.getElementById("top-bar");
  topBar.innerHTML = `
    <div class="top-row">
      <div><b>Te:</b> ${USER_NAME}</div>
      <div><b>Partner:</b> ${PARTNER_NAME}</div>
      <div><b>Szoba azonos√≠t√≥:</b> ${ROOM_ID}</div>
    </div>
  `;

  // -------------------------------------------------------------
  // MEGOSZT√ÅS ALAP√ö FELold√°s (5√ó ut√°n enged√©lyezve)
  // -------------------------------------------------------------
  let sharedCount = Number(localStorage.getItem(USER_NAME + "_share") || 0);

  function addShare() {
      sharedCount++;
      localStorage.setItem(USER_NAME + "_share", sharedCount);
      alert("K√∂sz√∂nj√ºk a megoszt√°st! (" + sharedCount + "/5)");
  }
  window.addShare = addShare;

  // -------------------------------------------------------------
  // MASZKOL√ÅS ‚Äì email + telefon
  // -------------------------------------------------------------
  function maskPhone(full) {
      if (!full) return "";
      full = full.replace(/\D/g, "");

      // magyar sz√°m +36‚Ä¶
      return full.replace(/^(\d{2})(\d{2})\d+(\d{2})$/,
          (m, p1, p2, pEnd) => p1 + p2 + "*****" + pEnd
      );
  }

  function maskEmail(email) {
      if (!email) return "";
      const [name, domain] = email.split("@");
      if (!domain) return email;

      const maskedName = name[0] + "***" + name[name.length-1];
      return maskedName + "@*****";
  }

  // -------------------------------------------------------------
  // FIRESTORE REF
  // -------------------------------------------------------------
  const chatRef = doc(db, "chats", ROOM_ID);
  const messagesRef = collection(db, "chats", ROOM_ID, "uzenetek");

  try {
      await updateDoc(chatRef, {
          roomId: ROOM_ID,
          status: "active",
          lastMessageAt: serverTimestamp()
      });
  } catch (e) {}

  // -------------------------------------------------------------
  // √úZENET FIGYEL√âS
  // -------------------------------------------------------------
  const chatBox = document.getElementById("chat-box");
  const q = query(messagesRef, orderBy("timestamp"));

  onSnapshot(q, (snapshot) => {
      chatBox.innerHTML = "";
      snapshot.forEach((docSnap) => {
          const msg = docSnap.data();

          const p = document.createElement("p");
          p.className = "msg";

          const own = msg.senderName === USER_NAME ? "own" : "";
          const time = formatTimestamp(msg.timestamp);

          p.innerHTML =
            `<span class="${own}">${escapeHtml(msg.senderName)}:</span> ` +
            `${escapeHtml(msg.text)} <span class="meta">(${time})</span>`;

          chatBox.appendChild(p);
      });

      chatBox.scrollTop = chatBox.scrollHeight;
  });

  // -------------------------------------------------------------
  // √úZENET K√úLD√âS
  // -------------------------------------------------------------
  document.getElementById("send-btn").onclick = () => userSendMessage();
  document.getElementById("message-input").onkeydown = (e) => {
      if (e.key === "Enter") userSendMessage();
  };

  // tiltott mint√°k
  function isContactInfo(text) {
      const phoneRegex = /(06\d{7,}|(\+36)\d{7,})/g;
      const emailRegex = /\S+@\S+\.\S+/g;
      const linkRegex = /(facebook\.com|instagram\.com|viber|t\.me|wa\.me)/g;

      return phoneRegex.test(text) ||
             emailRegex.test(text) ||
             linkRegex.test(text);
  }

  function canSendContact() {
      return sharedCount >= 5;
  }

  async function userSendMessage() {
      const input = document.getElementById("message-input");
      let text = input.value.trim();

      if (!text) return;

      if (isContactInfo(text) && !canSendContact()) {
          showWarning();
          input.value = "";
          return;
      }

      try {
          await addDoc(messagesRef, {
              senderName: USER_NAME,
              text,
              timestamp: serverTimestamp()
          });

          await updateDoc(chatRef, {
              lastMessageAt: serverTimestamp()
          });

      } catch (e) {
          alert("Hiba t√∂rt√©nt az √ºzenet k√ºld√©sekor!");
      }

      input.value = "";
  }

  // -------------------------------------------------------------
  // FIGYELMEZTET√âS
  // -------------------------------------------------------------
  function showWarning() {
      const warn = document.createElement("div");
      warn.className = "warning-msg";
      warn.innerHTML = `
          Kedves szaki/megrendel≈ë!<br><br>
          Az√©rt haszn√°lhatod ingyen az oldalt, mert itt a <b>CHAT-en</b>
          besz√©ltek meg minden fontos r√©szletet.<br><br>
          <b>5 MEGOSZT√ÅS ut√°n engedj√ºk az el√©rhet≈ës√©gek k√ºld√©s√©t!</b><br><br>
          K√∂sz√∂nj√ºk! üôè
      `;
      chatBox.appendChild(warn);
      chatBox.scrollTop = chatBox.scrollHeight;
  }

  // -------------------------------------------------------------
  // SZAKIV√ÅLASZT√ÅS ‚Äì GOMBOK
  // -------------------------------------------------------------
  document.getElementById("select-worker").onclick = () => {
      sendSystemMessage(
          `${USER_NAME} ezt a szakit v√°lasztotta ‚úî`
      );
      alert("K√∂sz√∂nj√ºk! R√∂gz√≠tett√ºk, hogy ezt a szakit v√°lasztottad.");
  };

  document.getElementById("select-other").onclick = () => {
      sendSystemMessage(
          `A megrendel≈ë m√°sik szakit v√°lasztott ‚ùå`
      );
      alert("R√∂gz√≠tve: m√°sik szakit v√°lasztott√°l.");
  };

  async function sendSystemMessage(text) {
      try {
          await addDoc(messagesRef, {
              senderName: "Rendszer",
              text,
              timestamp: serverTimestamp()
          });
      } catch (e) {}
  }

  // -------------------------------------------------------------
  // SEG√âDEK
  // -------------------------------------------------------------
  function createRoomId(a, b) {
      const x = (a || "").trim().toLowerCase();
      const y = (b || "").trim().toLowerCase();
      return [x, y].sort().join("__");
  }

  function escapeHtml(s) {
      const div = document.createElement("div");
      div.innerText = s;
      return div.innerHTML;
  }

  function formatTimestamp(ts) {
      try {
          const d = ts?.toDate ? ts.toDate() : new Date();
          return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
      } catch { return ""; }
  }

  function pad(n){ return n<10 ? "0"+n : n; }

</script>

</body>
</html>
