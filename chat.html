<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Chat ‚Äì Szaki-App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { margin:0; padding:0; background:#f5f5f5; font-family:Arial,sans-serif; }

    header {
      background:#ff8c00;
      padding:12px 16px;
      color:#fff;
      font-weight:bold;
      font-size:18px;
      text-align:center;
    }

    .top-bar {
      max-width:900px;
      margin:0 auto;
      background:#fff;
      padding:10px 14px;
      font-size:13px;
      border-bottom:1px solid #eee;
    }

    .top-row { display:flex; gap:16px; flex-wrap:wrap; }
    .top-row b { font-weight:bold; }

    .back-link {
      display:inline-block;
      margin-top:6px;
      font-size:13px;
      color:#007bff;
      text-decoration:none;
    }

    #chat-box {
      max-width:900px;
      margin:12px auto;
      padding:12px 14px;
      background:white;
      border-radius:10px;
      height:55vh;
      overflow-y:auto;
      box-shadow:0 2px 10px rgba(0,0,0,0.08);
    }

    .msg { margin:6px 0; font-size:14px; }
    .meta { color:#777; font-size:11px; margin-left:6px; }
    .own { font-weight:bold; }
    .del { margin-left:10px; color:#c00; cursor:pointer; font-size:11px; }

    .status-bar {
      max-width:900px;
      margin:0 auto 4px;
      padding:0 14px;
      font-size:11px;
      color:#666;
    }

    .input-row {
      max-width:900px;
      margin:0 auto 14px;
      display:flex;
      gap:8px;
      padding:0 14px;
    }

    #message-input {
      flex:1;
      padding:10px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:14px;
    }

    .send-btn {
      padding:10px 18px;
      border:none;
      border-radius:8px;
      background:#ff8c00;
      color:white;
      font-size:14px;
      font-weight:bold;
      cursor:pointer;
    }
  </style>
</head>
<body>
<header>Chat ‚Äì Szaki-App</header>

<div class="top-bar" id="top-bar"></div>

<div id="chat-box">
  <p><i>Csatlakozt√°l a besz√©lget√©shez‚Ä¶</i></p>
</div>

<div class="status-bar">
  <span id="room-status"></span>
  <span id="notify-indicator" style="display:none;color:#28a745;">√öj √ºzenet ‚óè</span>
</div>

<div class="input-row">
  <input type="text" id="message-input" placeholder="√çrj √ºzenetet‚Ä¶" />
  <button class="send-btn" id="send-btn">K√ºld√©s</button>
</div>

<!-- MEGRENDEL≈êI GOMBOK ‚Äì CSAK MEGRENDEL≈êNEK -->
<div id="lezaro-gombok" style="display:none; max-width:900px; margin:20px auto; padding:0 14px;">
    <button id="valasztom-btn"
        style="width:100%; padding:14px; background:#28a745; color:#fff; border:none;
               border-radius:8px; font-size:16px; font-weight:bold; margin-bottom:10px;">
        üëâ Ezt a szakembert v√°lasztom!
    </button>

    <button id="jobb-ajanlat-btn"
        style="width:100%; padding:14px; background:#c62828; color:#fff; border:none;
               border-radius:8px; font-size:16px; font-weight:bold;">
        ‚ùå K√∂sz√∂n√∂m, jobb aj√°nlatot kaptam
    </button>
</div>

<script type="module">
import { app, db } from "./firebase-config.js";
import {
  collection, doc, addDoc, query, orderBy, onSnapshot,
  serverTimestamp, updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const params = new URLSearchParams(window.location.search);

// Ki vagy?
let USER_NAME = params.get("sender") || localStorage.getItem("szakiName") || "Ismeretlen";
localStorage.setItem("szakiName", USER_NAME);

// Partner
const PARTNER_NAME = params.get("partner") || "Ismeretlen szakember";
const MEGRENDELO_NEV = params.get("megrendelonev") || "";
const SZAKMA = params.get("szakma") || "";

// Szoba azonos√≠t√≥
function canonicalRoom(a,b){
    return [a.trim().toLowerCase(), b.trim().toLowerCase()].sort().join("__");
}
const ROOM_ID = canonicalRoom(USER_NAME, PARTNER_NAME);

// Fejl√©c
document.getElementById("top-bar").innerHTML = `
  <div class="top-row">
    <div><b>Megrendel≈ë:</b> ${MEGRENDELO_NEV || "-"}</div>
    <div><b>Szakember:</b> ${PARTNER_NAME}</div>
    <div><b>Te most:</b> ${USER_NAME}</div>
  </div>
  <a class="back-link" href="valassz-szakit.html?szakma=${SZAKMA}&megrendelonev=${MEGRENDELO_NEV}">‚óÄ Vissza</a>
`;

document.getElementById("room-status").textContent = `Szoba: ${ROOM_ID}`;

const chatRef = doc(db, "chats", ROOM_ID);
const messagesRef = collection(db, "chats", ROOM_ID, "uzenetek");

// √úzenetfigyel√©s
const chatBox = document.getElementById("chat-box");
onSnapshot(query(messagesRef, orderBy("timestamp")), (snapshot) => {
  chatBox.innerHTML = "";
  snapshot.forEach((d) => {
    const m = d.data();
    if (m.deletedBy?.includes(USER_NAME)) return;

    const p = document.createElement("p");
    p.className = "msg";
    const own = m.senderName === USER_NAME ? "own" : "";
    const t = m.timestamp?.toDate?.() || new Date();
    const time = `${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`;

    p.innerHTML = `<span class="${own}">${m.senderName}:</span> ${m.text} <span class="meta">(${time})</span>`;
    chatBox.appendChild(p);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
});

// √úzenet k√ºld√©se
document.getElementById("send-btn").onclick = sendMessage;
document.getElementById("message-input").onkeydown = (e) => {
  if (e.key === "Enter") sendMessage();
};

async function sendMessage(){
  const text = document.getElementById("message-input").value.trim();
  if (!text) return;

  await addDoc(messagesRef, {
    senderName: USER_NAME,
    text,
    timestamp: serverTimestamp(),
    deletedBy: []
  });

  document.getElementById("message-input").value = "";
}

// --- MEGRENDEL≈êI GOMBOK LOGIKA ---

const userNow = USER_NAME.trim().toLowerCase();
const megNow = MEGRENDELO_NEV.trim().toLowerCase();
const lezaro = document.getElementById("lezaro-gombok");

// Csak megrendel≈ë l√°ssa
if (userNow && megNow && userNow === megNow) {
    lezaro.style.display = "block";
}

// 1) SZAKI KIV√ÅLASZT√ÅSA
document.getElementById("valasztom-btn").onclick = async () => {
    await addDoc(collection(db, "szaki-valasztas"), {
        megrendelo: MEGRENDELO_NEV,
        szakember: PARTNER_NAME,
        valasztas: "kivalasztva",
        timestamp: serverTimestamp()
    });

    // √ârtes√≠t√©s a szakinak
    await addDoc(messagesRef, {
        senderName: "Rendszer",
        text: `A megrendel≈ë t√©ged v√°lasztott! Gratul√°lunk!`,
        timestamp: serverTimestamp()
    });

    alert("K√∂sz√∂nj√ºk! A szakember megkapta az √©rtes√≠t√©st.");
};

// 2) SZAKI ELUTAS√çT√ÅSA
document.getElementById("jobb-ajanlat-btn").onclick = async () => {
    await addDoc(collection(db, "szaki-valasztas"), {
        megrendelo: MEGRENDELO_NEV,
        szakember: PARTNER_NAME,
        valasztas: "elutasitva",
        timestamp: serverTimestamp()
    });

    // Szaki √©rtes√≠t√©se
    await addDoc(messagesRef, {
        senderName: "Rendszer",
        text: `Sajnos a megrendel≈ë nem t√©ged v√°lasztott.`,
        timestamp: serverTimestamp()
    });

    alert("Mentve. A szakember √©rtes√≠t√©st kapott.");
};
</script>

<!-- Online st√°tusz k√∂vet√©se -->
<script type="module" src="szaki-online.js"></script>

</body>
</html>
