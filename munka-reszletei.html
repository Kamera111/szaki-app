<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8" />
    <title>Munka r√©szletei ‚Äì Szaki-App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        .wrap {
            max-width: 950px;
            margin: auto;
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        h1 { margin-top: 0; }
        textarea, input, select {
            width: 100%;
            padding: 12px;
            margin: 8px 0 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 15px;
        }
        .btn {
            width: 100%;
            padding: 14px;
            background: #ff8c00;
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 17px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn:active {
            transform: translateY(1px);
            filter: brightness(0.95);
        }
        .char {
            text-align: right;
            font-size: 13px;
        }
        .szakma-box {
            background: #fff8e1;
            padding: 14px;
            border-left: 4px solid #ff8800;
            border-radius: 8px;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>

<div class="wrap">

    <h1>2. l√©p√©s ‚Äì A munka r√©szletes le√≠r√°sa</h1>

    <div class="szakma-box">
        <b>V√°lasztott f≈ë szakma:</b>
        <span id="ossz-szakma"></span><br>
        <b>Helysz√≠n:</b> <span id="ossz-varos"></span><br>
        <b>Munka nagys√°ga:</b> <span id="ossz-meret"></span>
    </div>

    <label><b>R√©szletes le√≠r√°s (min. 300 karakter):</b></label>
    <textarea id="leiras" rows="6" placeholder="Pl.: 20 m¬≤ padl√≥ burkol√°s bont√°ssal, anyagot ki veszi, emelet, lift, parkol√°s, falak √°llapota‚Ä¶"></textarea>
    <div class="char"><span id="charcount">0</span> / 300</div>

    <label><b>Legkor√°bbi kezd√©s</b></label>
    <input type="date" id="kezdesMin" />

    <label><b>Legk√©s≈ëbbi kezd√©s</b></label>
    <input type="date" id="kezdesMax" />

    <label><b>V√°llalt hat√°rid≈ë</b></label>
    <input type="date" id="hatarido" />

    <label><b>Tov√°bbi szakm√°k (opcion√°lis):</b></label>
    <select id="extraSzakmak" multiple size="6">
        <option value="K≈ëm≈±ves">K≈ëm≈±ves</option>
        <option value="Fest≈ë">Fest≈ë</option>
        <option value="Burkol√≥">Burkol√≥</option>
        <option value="Gipszkartonos">Gipszkartonos</option>
        <option value="Villanyszerel≈ë">Villanyszerel≈ë</option>
        <option value="V√≠zszerel≈ë">V√≠zszerel≈ë</option>
        <option value="G√°zszerel≈ë">G√°zszerel≈ë</option>
        <option value="F≈±t√©sszerel≈ë">F≈±t√©sszerel≈ë</option>
        <option value="Kl√≠maszerel≈ë">Kl√≠maszerel≈ë</option>
    </select>

    <button class="btn" onclick="mentes()">Megrendel√©s elk√ºld√©se</button>

</div>

<script type="module">

    import { db } from "./firebase-config.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // --- 1) Alapadatok bet√∂lt√©se az 1. l√©p√©sb≈ël ---
    const nev = localStorage.getItem("mr_nev") || "";
    const varos = localStorage.getItem("mr_varos") || "";
    const szakma = localStorage.getItem("mr_szakma") || "";
    const meret = localStorage.getItem("mr_meret") || "";

    document.getElementById("ossz-szakma").textContent = szakma;
    document.getElementById("ossz-varos").textContent = varos;
    document.getElementById("ossz-meret").textContent = meret;

    // --- 2) Karaktersz√°ml√°l√≥ ---
    const textarea = document.getElementById("leiras");
    const countEl = document.getElementById("charcount");

    textarea.addEventListener("input", () => {
        const hossz = textarea.value.trim().length;
        countEl.textContent = hossz;
    });

    // --- 3) Megrendel√©s ment√©se Firestore-ba ---
    async function mentes() {

        const leiras = textarea.value.trim();
        const kezdesMin = document.getElementById("kezdesMin").value;
        const kezdesMax = document.getElementById("kezdesMax").value;
        const hatarido = document.getElementById("hatarido").value;

        const extraSzakmak = Array.from(
            document.getElementById("extraSzakmak").selectedOptions
        ).map(o => o.value);

        if (leiras.length < 300) {
            alert("A le√≠r√°snak minimum 300 karakter hossz√∫nak kell lennie!");
            return;
        }
        if (!kezdesMin || !kezdesMax || !hatarido) {
            alert("K√©rlek t√∂ltsd ki az id≈ëpontokat!");
            return;
        }

        try {
            const docRef = await addDoc(collection(db, "munkak"), {
                nev,
                varos,
                szakmaFo: szakma,
                szakmakLista: [szakma, ...extraSzakmak],
                meret,
                leiras,
                kezdesMin,
                kezdesMax,
                hatarido,
                createdAt: serverTimestamp(),
                status: "uj"
            });

            alert("A megrendel√©s sikeresen r√∂gz√≠tve! A rendszer most √∂sszekapcsol a szakikkal.");

            // üî• Tov√°bb a szakikeres≈ë oldalra:
            window.location.href =
                "valassz-szakit.html?szakma=" +
                encodeURIComponent(szakma) +
                "&megrendelonev=" +
                encodeURIComponent(nev);

        } catch (err) {
            console.error("Firestore hiba:", err);
            alert("Hiba t√∂rt√©nt a ment√©s k√∂zben!");
        }
    }

    window.mentes = mentes;

</script>

</body>
</html>
