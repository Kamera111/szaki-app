<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Szaki profil – Szaki-App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            margin:0; padding:20px;
            font-family:Arial; background:#f5f5f5;
        }
        .card {
            max-width:600px; margin:auto; background:white;
            padding:20px; border-radius:10px;
            box-shadow:0 2px 10px rgba(0,0,0,0.1);
        }
        h2 { margin:0 0 10px 0; }
        .online { color:#28a745; font-weight:bold; }
        .offline { color:#c00; font-weight:bold; }
        .mask { color:#777; }
        .section-title {
            margin-top:20px; font-weight:bold; font-size:16px;
            border-bottom:1px solid #ddd; padding-bottom:6px;
        }
        .btn {
            display:block; width:100%; margin-top:16px;
            padding:12px; background:#ff8c00; color:white;
            font-size:16px; border:none; border-radius:8px;
            font-weight:bold; cursor:pointer; text-align:center;
            text-decoration:none;
        }
        .skills, .info-line {
            margin:4px 0; font-size:14px;
        }
        .label { font-weight:bold; }
        .avatar {
            width:110px; height:110px; border-radius:50%;
            object-fit:cover; border:3px solid #ff8c00;
            margin-bottom:15px;
        }
    </style>
</head>

<body>

<div class="card">

    <img id="avatar" class="avatar" src="" alt="Profilkép">

    <h2 id="name">Betöltés…</h2>
    <div id="online-status"></div>

    <div class="section-title">Szakmák</div>
    <div id="professions" class="skills"></div>

    <div class="section-title">Elérhetőségek (maszkolva)</div>
    <div class="info-line"><span class="label">Telefon:</span> <span id="phone" class="mask"></span></div>
    <div class="info-line"><span class="label">E-mail:</span> <span id="email" class="mask"></span></div>

    <div class="section-title">Bemutatkozó</div>
    <div id="description" class="skills"></div>

    <div class="section-title">Legutóbb online</div>
    <div id="last-online" class="skills"></div>

    <a id="chat-btn" class="btn">Chat indítása</a>
</div>

<script type="module">

    import { app, db } from "./firebase-config.js";
    import {
        doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    import {
        maskPhone, maskEmail
    } from "./masking.js";

    import {
        getLastOnline
    } from "./users-status.js";

    // ---------------------------------------------------
    // URL PARAMÉTEREK
    // ---------------------------------------------------
    const params = new URLSearchParams(window.location.search);
    const szakiId = params.get("id");              // Firestore dokumentum ID
    const megrendeloNev = params.get("megrendelonev") || "";
    const orderId = params.get("orderId") || "";

    if (!szakiId) {
        alert("Hiba: nincs megadva szaki ID!");
    }

    // ---------------------------------------------------
    // ELEMEK
    // ---------------------------------------------------
    const nameEl = document.getElementById("name");
    const profEl = document.getElementById("professions");
    const phoneEl = document.getElementById("phone");
    const emailEl = document.getElementById("email");
    const descEl = document.getElementById("description");
    const avatarEl = document.getElementById("avatar");
    const onlineEl = document.getElementById("online-status");
    const lastOnlineEl = document.getElementById("last-online");
    const chatBtn = document.getElementById("chat-btn");

    // ---------------------------------------------------
    // SZAKI ADATOK BETÖLTÉSE FIRESTORE-BÓL
    // ---------------------------------------------------
    async function loadSzaki() {

        const ref = doc(db, "users", szakiId);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
            nameEl.textContent = "Nincs ilyen szakember.";
            return;
        }

        const data = snap.data();

        // ---------------------------------------------------
        // NÉV, AVATAR
        // ---------------------------------------------------
        nameEl.textContent = data.name || "Ismeretlen";
        avatarEl.src = data.avatar || "https://via.placeholder.com/110";

        // ---------------------------------------------------
        // SZAKMÁK
        // ---------------------------------------------------
        if (Array.isArray(data.professions)) {
            profEl.textContent = data.professions.join(", ");
        } else {
            profEl.textContent = data.profession || "-";
        }

        // ---------------------------------------------------
        // TELEFON & EMAIL MASZKOLÁSA
        // ---------------------------------------------------
        phoneEl.textContent = data.phone ? maskPhone(data.phone) : "-";
        emailEl.textContent = data.email ? maskEmail(data.email) : "-";

        // ---------------------------------------------------
        // BEMUTATKOZÁS
        // ---------------------------------------------------
        descEl.textContent = data.description || "Nincs megadva.";

        // ---------------------------------------------------
        // ONLINE / OFFLINE
        // ---------------------------------------------------
        const last = await getLastOnline(data.name);
        if (last === "online") {
            onlineEl.innerHTML = `<span class="online">● Online</span>`;
        } else {
            onlineEl.innerHTML = `<span class="offline">● Offline</span>`;
        }

        lastOnlineEl.textContent = last || "Nincs adat";

        // ---------------------------------------------------
        // CHAT GOMB
        // ---------------------------------------------------
        chatBtn.href =
            `chat.html?sender=${encodeURIComponent(megrendeloNev)}` +
            `&partner=${encodeURIComponent(data.name)}` +
            `&orderId=${encodeURIComponent(orderId)}`;
    }

    loadSzaki();

</script>

</body>
</html>
