<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Szakember v√°laszt√°sa ‚Äì SzakiChat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">

    <style>
        header {
            background:#007aff;
            color:white;
            padding:16px;
            font-size:22px;
            text-align:center;
        }

        .container {
            max-width:450px;
            margin:25px auto;
            background:white;
            padding:20px;
            border-radius:12px;
            box-shadow:0 4px 14px rgba(0,0,0,0.08);
        }

        .box { margin-bottom:28px; }
        .ads-box {
            background:#f1f1f1;
            padding:12px;
            border-radius:8px;
            text-align:center;
            color:#777;
        }

        .btn {
            width:100%;
            padding:12px;
            background:#007aff;
            border:none;
            border-radius:8px;
            cursor:pointer;
            color:white;
            font-weight:bold;
        }

        .btn:hover { transform:scale(1.03); }

        /* ‚ù§Ô∏è lebeg≈ë gomb */
        @keyframes heartbeat {
            0%{transform:scale(1);}
            25%{transform:scale(1.25);}
            40%{transform:scale(1);}
            60%{transform:scale(1.25);}
            100%{transform:scale(1);}
        }
        #supportFloatingBtn {
            position:fixed;
            bottom:22px;
            right:22px;
            background:#ff2d55;
            padding:14px 22px;
            border-radius:40px;
            color:white;
            font-weight:bold;
            display:flex;
            gap:10px;
            cursor:pointer;
            box-shadow:0 4px 15px rgba(0,0,0,0.25);
        }
        .heart { animation:heartbeat 1.4s infinite; }
    </style>
</head>

<body>

<header>Szakember v√°laszt√°sa</header>

<div class="container">

    <!-- INFO -->
    <div class="box" id="infoBox">Bet√∂lt√©s...</div>

    <!-- MEGOSZT√ÅS LIMIT -->
    <div class="box" id="shareBox" style="background:#fff4e6; padding:15px; border-radius:10px;">
        Bet√∂lt√©s...
    </div>

    <!-- REKL√ÅM -->
    <div class="ads-box">
        üî∂ Rekl√°m hely ‚Äì Google Ads vagy banner
    </div>

    <!-- SZAKI LISTA -->
    <div id="szakiLista"></div>
</div>

<!-- ‚ù§Ô∏è t√°mogat√°s gomb -->
<div id="supportFloatingBtn"
     onclick="window.open('https://www.paypal.com/donate/?hosted_button_id=QGU3WXVSCH22A','_blank')">
    <span class="heart">‚ù§Ô∏è</span> T√°mogasd a SzakiChat-et
</div>


<script type="module">
/* ======================================
   FIREBASE IMPORT
====================================== */
import { db, auth } from "./firebase-config.js";

import {
    onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
    collection,
    query,
    where,
    getDocs,
    doc,
    getDoc,
    updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";


/* ======================================
   1) BEL√âP√âS ELLEN≈êRZ√âS
====================================== */
let uid = null;
let userData = null;

onAuthStateChanged(auth, async (user) => {
    if (!user) {
        window.location.href = "login.html";
        return;
    }

    uid = user.uid;

    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
        alert("Hi√°nyz√≥ profiladat!");
        window.location.href = "profil.html";
        return;
    }

    userData = snap.data();

    // csak megrendel≈ë l√©phet be ide!
    if (userData.role !== "megrendelo") {
        window.location.href = "szaki-panel.html";
        return;
    }

    loadPage();
});


/* ======================================
   2) HTML FRISS√çT√âS + SZAKMA BEOLVAS√ÅS
====================================== */
async function loadPage() {
    const params = new URLSearchParams(window.location.search);
    const szakma = params.get("szakma") || "(ismeretlen)";

    document.getElementById("infoBox").innerHTML = `
        <b>Keresett szakma:</b> ${szakma}<br>
        <small>A k√∂vetkez≈ë szakik √©rhet≈ëk el:</small>
    `;

    updateShareBox();

    await loadSzakik(szakma);
}


/* ======================================
   3) MEGOSZT√ÅS LIMIT FIRESTORE-B√ìL
====================================== */
async function updateShareBox() {
    const count = userData.shareCount || 0;

    document.getElementById("shareBox").innerHTML = `
        <b>A szakik el√©rhet≈ës√©ge z√°rolva!</b><br><br>
        Oszd meg az oldalt legal√°bb <b>5 alkalommal</b> a felold√°shoz.<br><br>
        Jelenlegi megoszt√°sok: <b>${count}</b> / 5<br><br>
        <button class="btn" id="shareBtn">Megosztottam</button>
    `;

    document.getElementById("shareBtn").onclick = addShare;
}

async function addShare() {
    let count = userData.shareCount || 0;
    if (count < 5) count++;

    await updateDoc(doc(db, "users", uid), {
        shareCount: count
    });

    userData.shareCount = count;

    updateShareBox();
    loadSzakik(); // friss√≠t√©s
}


/* ======================================
   4) SZAKI LISTA T√ñLT√âSE FIRESTORE-B√ìL
====================================== */
async function loadSzakik(szakma) {
    const cont = document.getElementById("szakiLista");
    cont.innerHTML = "Bet√∂lt√©s...";

    const q = query(
        collection(db, "users"),
        where("role", "==", "szaki"),
        where("szakma", "==", szakma)
    );

    const snap = await getDocs(q);

    cont.innerHTML = "";

    if (snap.empty) {
        cont.innerHTML = "<p>Nincs ilyen szakember online.</p>";
        return;
    }

    snap.forEach(docu => {
        const sz = docu.data();
        const locked = (userData.shareCount || 0) < 5;

        const div = document.createElement("div");
        div.className = "box";

        div.innerHTML = `
            <h3>${sz.name}</h3>
            <div><b>Szakma:</b> ${sz.szakma}</div>
            <div style="margin-top:8px;">
                <b>El√©rhet≈ës√©g:</b>
                ${locked ? "<span style='color:red;'>üóù Z√°rolva</span>" : sz.phone || "Nincs megadva"}
            </div>

            <button class="btn" style="margin-top:12px;">
                Chat ind√≠t√°sa
            </button>
        `;

        div.querySelector(".btn").onclick = () => {
            window.location.href =
                "chat.html?partnerID=" + docu.id;
        };

        cont.appendChild(div);
    });
}
</script>

</body>
</html>
