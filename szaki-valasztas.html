<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Szakember v√°laszt√°s ‚Äì SzakiChat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>

<body>

<header>Szakember v√°laszt√°s</header>

<div class="container">

    <!-- Megrendel≈ë adatai + v√°lasztott szakma -->
    <div class="box" id="infoBox"></div>

    <!-- Megoszt√°si figyelmeztet√©s -->
    <div class="box box-info">
        <b>A szakik el√©rhet≈ës√©ge z√°rolva!</b><br><br>
        Oszd meg az oldalt legal√°bb <b>5 alkalommal</b>.
        <br><br>
        Megoszt√°sok: <span id="shareCount">0</span> / 5
        <br><br>
        <button class="btn" id="shareBtn">Megosztom</button>
    </div>

    <!-- Rekl√°m -->
    <div class="ads-box">
        üî∂ Rekl√°m hely ‚Äì Google Ads vagy banner
    </div>

    <!-- SZAKI LISTA -->
    <div id="szakiLista"></div>

</div>

<!-- ‚ù§Ô∏è T√ÅMOGAT√ì GOMB -->
<div id="supportFloatingBtn"
     onclick="window.open('https://www.paypal.com/donate/?hosted_button_id=QGU3WXVSCH22A','_blank')">
    <span class="heart">‚ù§Ô∏è</span> T√°mogasd a SzakiChat-et
</div>


<script type="module">
/* ============================================================
   FIREBASE IMPORT
============================================================ */
import { auth, db } from "./firebase-config.js";

import {
    onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
    doc,
    getDoc,
    setDoc,
    updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";


/* ============================================================
   URL PARAM√âTER: SZAKMA
============================================================ */
const params = new URLSearchParams(window.location.search);
const szakma = params.get("szakma");

document.getElementById("infoBox").innerHTML =
    `<b>Keresett szakma:</b> ${szakma}<br>
     <small>El√©rhet≈ë szakemberek:</small>`;


/* ============================================================
   USER + MEGOSZT√ÅS
============================================================ */
let uid = null;
let userData = null;

let shareCount = Number(localStorage.getItem("shareCount") || 0);
document.getElementById("shareCount").innerText = shareCount;

document.getElementById("shareBtn").onclick = () => {
    shareCount++;
    localStorage.setItem("shareCount", shareCount);
    document.getElementById("shareCount").innerText = shareCount;
    renderList();
};


/* ============================================================
   BEL√âP√âS ELLEN≈êRZ√âS
============================================================ */
onAuthStateChanged(auth, async (user) => {
    if (!user) return (window.location.href = "login.html");

    uid = user.uid;

    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);

    userData = snap.data();

    renderList();
});


/* ============================================================
   SZAKI LISTA (√ÅLTALAD K√âS≈êBB FIRESTORE-B√ìL J√ñHET)
============================================================ */
const realSzakik = [
    { id: "szaki1", name: "Csabi", szakma: "Fest≈ë", online: true },
    { id: "szaki2", name: "Zsolti", szakma: "Villanyszerel≈ë", online: false }
];

const fakeNames = ["P√©ter", "Attila", "Jani", "G√°bor", "Tam√°s"];
const fakeSzakik = fakeNames.map((n, i) => ({
    id: "fake" + i,
    name: n,
    szakma: szakma,
    online: false
}));

let allWorkers = [...realSzakik, ...fakeSzakik];


/* ============================================================
   CHAT IND√çT√ÅSA ‚Äì CHAT L√âTREHOZ√ÅSA
============================================================ */
async function startChat(partnerID) {
    // ABC sorrend a stabil chatID miatt
    const chatID = uid < partnerID ? `${uid}_${partnerID}` : `${partnerID}_${uid}`;

    const chatRef = doc(db, "chats", chatID);
    const chatSnap = await getDoc(chatRef);

    // Ha m√©g nincs chat ‚Üí l√©trehozzuk
    if (!chatSnap.exists()) {
        await setDoc(chatRef, {
            participants: [uid, partnerID],
            createdAt: Date.now(),
            lastMessage: "",
            lastTimestamp: Date.now()
        });
    }

    // √Åtir√°ny√≠t√°s a chat oldalra
    window.location.href =
        `chat.html?chatID=${chatID}&partner=${partnerID}`;
}


/* ============================================================
   LISTA KIRAJZOL√ÅS
============================================================ */
function renderList() {
    const cont = document.getElementById("szakiLista");
    cont.innerHTML = "";

    const locked = shareCount < 5;

    allWorkers.forEach(sz => {
        const box = document.createElement("div");
        box.className = "box";

        box.innerHTML = `
            <h3>${sz.name}</h3>
            <div><b>Szakma:</b> ${sz.szakma}</div>
            <div><b>Online:</b> ${sz.online ? "üü¢" : "‚ö™"}</div>

            <button class="btn" style="margin-top:12px;">Chat ind√≠t√°sa</button>
        `;

        box.querySelector("button").onclick = () => startChat(sz.id);

        cont.appendChild(box);
    });
}
</script>

</body>
</html>
