<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8" />
    <title>Szakember v√°laszt√°s ‚Äì Szaki-App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
        body {
            margin:0;
            padding:0;
            background:#f2f2f2;
            font-family:Arial, sans-serif;
        }

        header {
            background:#ff8c00;
            color:white;
            padding:14px;
            font-size:20px;
            font-weight:bold;
            text-align:center;
        }

        .container {
            max-width:900px;
            margin:20px auto;
            padding:10px;
        }

        .card {
            background:white;
            border-radius:12px;
            padding:16px;
            margin-bottom:16px;
            box-shadow:0 2px 6px rgba(0,0,0,0.08);
        }

        .name {
            font-size:20px;
            font-weight:bold;
        }

        .profession {
            font-size:14px;
            color:#666;
        }

        .online {
            color:#28a745;
            font-weight:bold;
            font-size:13px;
        }
        .offline {
            color:#c00;
            font-weight:bold;
            font-size:13px;
        }

        .actions {
            margin-top:12px;
            display:flex;
            gap:10px;
        }

        button {
            flex:1;
            padding:10px;
            border:none;
            border-radius:8px;
            font-size:14px;
            font-weight:bold;
            cursor:pointer;
        }

        .btn-chat {
            background:#007bff;
            color:white;
        }
        .btn-profile {
            background:#555;
            color:white;
        }
    </style>
</head>
<body>

<header>Szakember v√°laszt√°sa</header>

<div class="container" id="list"></div>

<script type="module">

    import { db } from "./firebase-config.js";
    import { getDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { findBestSzakik } from "./matching.js";
    import { maskPhone } from "./masking.js";

    const params = new URLSearchParams(window.location.search);

    const orderId       = params.get("orderId");
    const profession    = params.get("szakma");
    const city          = params.get("city") || "Budapest";
    const description   = params.get("desc") || "";
    const userName      = params.get("name") || "Megrendel≈ë";

    if (!orderId || !profession) {
        document.getElementById("list").innerHTML =
            "<p>Hi√°nyz√≥ adatok. T√©rj vissza a munka megad√°s√°hoz.</p>";
        throw new Error("Missing params");
    }

    const container = document.getElementById("list");

    // üî• Matching ‚Äî 3 szakember aj√°nl√°sa
    const rec = await findBestSzakik({
        profession,
        city,
        description
    });

    // ha nincs el√©rhet≈ë szaki
    if (!rec || rec.length === 0) {
        container.innerHTML = "<p>Nincs el√©rhet≈ë szakember ehhez a munk√°hoz.</p>";
        return;
    }

    // szakik renderel√©se
    rec.slice(0, 3).forEach(sz => {

        const div = document.createElement("div");
        div.className = "card";

        const onlineLabel = sz.isOnline
            ? `<span class="online">‚óè el√©rhet≈ë</span>`
            : `<span class="offline">‚óè nem el√©rhet≈ë</span>`;

        div.innerHTML = `
            <div class="name">${sz.name}</div>
            <div class="profession">${sz.profession}</div>
            <div>${onlineLabel}</div>
            <div style="margin-top:6px;">Telefon: <b>${maskPhone(sz.phone)}</b></div>
        `;

        // gombok
        const actions = document.createElement("div");
        actions.className = "actions";

        // CHAT
        const chatBtn = document.createElement("button");
        chatBtn.className = "btn-chat";
        chatBtn.textContent = "Chat ind√≠t√°sa";
        chatBtn.onclick = () => {

            window.location.href =
                `chat.html?sender=${encodeURIComponent(userName)}` +
                `&partner=${encodeURIComponent(sz.name)}` +
                `&orderId=${encodeURIComponent(orderId)}` +
                `&szakma=${encodeURIComponent(profession)}`;
        };

        // PROFIL
        const viewBtn = document.createElement("button");
        viewBtn.className = "btn-profile";
        viewBtn.textContent = "Profil megtekint√©se";
        viewBtn.onclick = () => {
            window.location.href =
                `szaki-profil.html?name=${encodeURIComponent(sz.name)}`;
        };

        actions.appendChild(chatBtn);
        actions.appendChild(viewBtn);
        div.appendChild(actions);

        container.appendChild(div);
    });

</script>

</body>
</html>
