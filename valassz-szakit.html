<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<title>V√°lassz szakit ‚Äì Szaki-App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
    body {
        background:#f5f5f5;
        margin:0;
        font-family:Arial,sans-serif;
        padding:15px;
    }

    h2 { text-align:center; margin-bottom:20px; }

    .worker-card{
        background:white;
        border-radius:10px;
        padding:15px;
        margin-bottom:14px;
        box-shadow:0 2px 8px rgba(0,0,0,0.08);
    }

    .worker-name{
        font-size:18px;
        font-weight:bold;
    }

    .worker-prof{
        color:#666;
        margin-top:4px;
    }

    .worker-status{
        margin-top:6px;
        font-size:13px;
        color:#444;
    }

    .select-btn{
        margin-top:12px;
        width:100%;
        padding:10px;
        background:#ff8c00;
        color:white;
        border:none;
        border-radius:8px;
        font-weight:bold;
        cursor:pointer;
    }
</style>
</head>
<body>

<h2>V√°lassz szakit</h2>

<div id="worker-list"></div>

<script type="module">

//---------------------------------------------------------
// IMPORTOK
//---------------------------------------------------------
import { app, db } from "./firebase-config.js";
import {
    collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

import {
    watchUserStatus,
    formatLastActive
} from "./users-status.js";

import "./masking.js";
import "./szaki-adatok.js";

//---------------------------------------------------------
// URL PARAM√âTEREK
//---------------------------------------------------------
const params = new URLSearchParams(window.location.search);
const megrendelonev = params.get("name") || "Megrendel≈ë";
const szakma = params.get("szakma");

//---------------------------------------------------------
// SZAKI LISTA BET√ñLT√âSE
//---------------------------------------------------------
const listEl = document.getElementById("worker-list");

// Saj√°t adatb√°zis (helyi)
const allSzakik = window.SzakiAdatok.getAllSzakik()
    .filter(s => {
        if (Array.isArray(s.profession)) return s.profession.includes(szakma);
        return s.profession === szakma;
    });

// Firestore (felhaszn√°l√≥i st√°tusz + el√©rhet≈ës√©gek)
const usersRef = collection(db, "users");
const snap = await getDocs(usersRef);

const firestoreUsers = {};
snap.forEach(d => firestoreUsers[d.id] = d.data());

//---------------------------------------------------------
// LISTA KIRAJZOL√ÅSA
//---------------------------------------------------------
allSzakik.forEach(sz => {

    // Firestore user adatok
    const fUser = firestoreUsers[sz.name] || {};

    // MASZKOLT TELEFON
    const maskedPhone = window.Mask.phone(sz.phone);

    const card = document.createElement("div");
    card.className = "worker-card";

    card.innerHTML = `
        <div class="worker-name">${sz.name}</div>
        <div class="worker-prof">${sz.profession}</div>

        <div class="worker-status" id="status-${sz.name.replace(/\s+/g,'')}">
            St√°tusz bet√∂lt√©se‚Ä¶
        </div>

        <div style="margin-top:6px; font-size:13px;">
            Telefonsz√°m: <b>${maskedPhone}</b>
        </div>

        <button class="select-btn"
            onclick="window.location.href='chat.html?sender=${encodeURIComponent(megrendelonev)}&partner=${encodeURIComponent(sz.name)}'">
            Chat ind√≠t√°sa
        </button>
    `;

    listEl.appendChild(card);

    //-----------------------------------------------------
    // REALTIME ONLINE ST√ÅTUSZ MEGFIGYEL√âS
    //-----------------------------------------------------
    const statusEl = document.getElementById("status-" + sz.name.replace(/\s+/g,''));

    watchUserStatus(sz.name, (data) => {
        if (!data) {
            statusEl.textContent = "Nincs adat";
            return;
        }

        if (data.isOnline) {
            statusEl.textContent = "üü¢ Online";
        } else {
            statusEl.textContent = "‚ö™ Utolj√°ra akt√≠v: " + formatLastActive(data.lastActive);
        }
    });
});

</script>

</body>
</html>
